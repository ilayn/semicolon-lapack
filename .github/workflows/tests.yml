name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  get_commit_message:
    name: Get commit message
    uses: ./.github/workflows/commit_message.yml

  test-linux:
    name: Test Linux OpenBLAS
    needs: get_commit_message
    if: needs.get_commit_message.outputs.run_tests == '1'
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -el {0}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Miniforge
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-version: latest
          activate-environment: ci
          environment-file: ''

      - name: Install dependencies
        run: >-
          conda install -y
          c-compiler
          openblas
          meson
          ninja
          cmake
          pkg-config

      - name: Install CMocka 2.0
        run: |
          git clone --depth 1 --branch cmocka-2.0.0 https://gitlab.com/cmocka/cmocka.git
          cmake -S cmocka -B cmocka/build -DCMAKE_INSTALL_PREFIX=$CONDA_PREFIX -DBUILD_SHARED_LIBS=ON
          cmake --build cmocka/build
          cmake --install cmocka/build

      - name: Print environment info
        run: |
          echo "=== CPU ==="
          lscpu | grep -E 'Model name|CPU\(s\)|Thread|Architecture|Vendor'
          echo ""
          echo "=== Memory ==="
          free -h | head -2
          echo ""
          echo "=== Compiler ==="
          cc --version | head -1

      - name: Configure
        run: meson setup builddir -Dblas=openblas

      - name: Build
        run: ninja -C builddir

      - name: Print OpenBLAS runtime info
        run: |
          cc -o openblas_info tests/ci/openblas_info.c \
            $(pkg-config --cflags --libs openblas)
          ./openblas_info

      - name: Test
        run: meson test -C builddir --print-errorlogs

  test-windows:
    name: Test Windows MSYS2 UCRT64
    needs: get_commit_message
    if: needs.get_commit_message.outputs.run_tests == '1'
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4

      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          cache: true
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-meson
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-openblas
            mingw-w64-ucrt-x86_64-pkg-config
            mingw-w64-ucrt-x86_64-tools
            git

      - name: Print environment info
        run: |
          echo "=== CPU ==="
          cat /proc/cpuinfo | grep 'model name' | head -1
          echo "Cores: $(nproc)"
          echo ""
          echo "=== Compiler ==="
          cc --version | head -1
          echo ""
          echo "=== OpenBLAS ==="
          pacman -Q mingw-w64-ucrt-x86_64-openblas

      - name: Install CMocka 2.0
        run: |
          git clone --depth 1 --branch cmocka-2.0.0 https://gitlab.com/cmocka/cmocka.git
          cmake -S cmocka -B cmocka/build -G Ninja \
            -DCMAKE_INSTALL_PREFIX=$MSYSTEM_PREFIX \
            -DBUILD_SHARED_LIBS=ON
          cmake --build cmocka/build
          cmake --install cmocka/build

      - name: Configure
        run: meson setup builddir -Dblas=openblas --default-library=shared
        env:
          CFLAGS: -DDGGEV_DEBUG

      - name: Build
        run: ninja -C builddir

      - name: Check for FMA instructions in compiled library
        run: |
          echo "=== FMA instruction count in libsemilapack ==="
          objdump -d builddir/src/libsemilapack*.dll 2>/dev/null | grep -ci 'vfma' || echo "0"
          echo "=== Sample FMA context (first 30 lines) ==="
          objdump -d builddir/src/libsemilapack*.dll 2>/dev/null | grep -B2 -A2 -i 'vfma' | head -30 || echo "none found"
        continue-on-error: true

      - name: Print OpenBLAS runtime info
        run: |
          cc -o openblas_info.exe tests/ci/openblas_info.c \
            $(pkg-config --cflags --libs openblas)
          ./openblas_info.exe

      # Experiment 1: DGGEV_DEBUG output shows ilo/ihi and H,T hash
      # for each dggev call.  If H_hash/T_hash match between V,V and
      # N,N, the divergence is inside dhgeqz.  If they differ, it is
      # in dgeqrf/dormqr/dgghrd (different dgeqrf icols).
      - name: "Exp 1: DGGEV_DEBUG ilo/ihi + H,T hash"
        run: |
          export PATH="$(pwd)/builddir/src:$PATH"
          echo "=== ddrgev ==="
          builddir/tests/d/test_ddrgev.exe > /tmp/ddrgev.txt 2>&1 || true
          echo "--- N,N calls with preceding V,V hashes (test5 only) ---"
          grep -B2 'DGGEV(N' /tmp/ddrgev.txt | head -120
          echo "--- Failures ---"
          grep -iE '(FAIL|mismatch)' /tmp/ddrgev.txt | head -60
          echo ""
          echo "=== sdrgev ==="
          builddir/tests/s/test_sdrgev.exe > /tmp/sdrgev.txt 2>&1 || true
          echo "--- N,N calls with preceding V,V hashes (test5 only) ---"
          grep -B2 'SGGEV(N' /tmp/sdrgev.txt | head -120
          echo "--- Failures ---"
          grep -iE '(FAIL|mismatch)' /tmp/sdrgev.txt | head -60
        continue-on-error: true
        env:
          OPENBLAS_NUM_THREADS: 1

      # Experiment 2: rebuild without GCC auto-vectorization to check
      # whether GCC's SIMD codegen causes the V,V vs N,N divergence.
      - name: "Exp 2: Configure without auto-vectorization"
        run: meson setup builddir_novec -Dblas=openblas --default-library=shared
        env:
          CFLAGS: -fno-tree-vectorize
        continue-on-error: true

      - name: "Exp 2: Build without auto-vectorization"
        run: ninja -C builddir_novec
        continue-on-error: true

      - name: "Exp 2: Test without auto-vectorization"
        run: |
          export PATH="$(pwd)/builddir_novec/src:$PATH"
          echo "=== ddrgev (no vectorization) ==="
          builddir_novec/tests/d/test_ddrgev.exe 2>&1; echo "exit: $?"
          echo ""
          echo "=== ddrgev3 (no vectorization) ==="
          builddir_novec/tests/d/test_ddrgev3.exe 2>&1; echo "exit: $?"
          echo ""
          echo "=== sdrgev (no vectorization) ==="
          builddir_novec/tests/s/test_sdrgev.exe 2>&1; echo "exit: $?"
          echo ""
          echo "=== sdrgev3 (no vectorization) ==="
          builddir_novec/tests/s/test_sdrgev3.exe 2>&1; echo "exit: $?"
        continue-on-error: true
        env:
          OPENBLAS_NUM_THREADS: 1

      - name: Test
        run: meson test -C builddir --print-errorlogs
        continue-on-error: true
        env:
          OPENBLAS_NUM_THREADS: 1

      # --- MSVC consumer test: compile a C program with cl.exe against the
      #     MinGW-built DLL to verify cross-compiler ABI (GCC). ---

      - name: Install to staging area
        run: |
          DESTDIR=$(pwd)/staging meson install -C builddir --no-rebuild

      - name: Detect DLL name
        id: dll_name
        run: |
          # Meson on MinGW may produce semilapack.dll or libsemilapack.dll
          if [ -f builddir/src/libsemilapack.dll ]; then
            echo "dll=libsemilapack" >> $GITHUB_OUTPUT
          else
            echo "dll=semilapack" >> $GITHUB_OUTPUT
          fi

      - name: Collect DLLs and installed headers for MSVC test
        run: |
          DLL=${{ steps.dll_name.outputs.dll }}
          mkdir msvc_test
          cp builddir/src/${DLL}.dll msvc_test/
          cp /$MSYSTEM/bin/libopenblas.dll msvc_test/
          for dll in libgcc_s_seh-1.dll libgfortran-5.dll libgomp-1.dll libwinpthread-1.dll libquadmath-0.dll; do
            [ -f /$MSYSTEM/bin/$dll ] && cp /$MSYSTEM/bin/$dll msvc_test/
          done
          # Copy installed headers (INT resolved, proper layout)
          mkdir -p msvc_test/include
          cp -r "$(find staging -type d -name semicolon_lapack)" msvc_test/include/
          echo "=== Installed headers ==="
          ls -la msvc_test/include/semicolon_lapack/

      - name: Generate MSVC import library
        run: |
          DLL=${{ steps.dll_name.outputs.dll }}
          gendef - builddir/src/${DLL}.dll > msvc_test/semilapack.def
          echo "=== .def file: first 10 lines ==="
          head -10 msvc_test/semilapack.def
          NEXPORTS=$(grep -c '^ ' msvc_test/semilapack.def || true)
          echo "=== Total exports: $NEXPORTS ==="

      - name: Build and run MSVC consumer test
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
          cd msvc_test
          lib /def:semilapack.def /out:semilapack.lib /machine:x64 /nologo
          cl.exe /std:c11 /O2 /W3 /nologo ^
            /I "include" ^
            ..\tests\ci\msvc_consumer_test.c ^
            semilapack.lib ^
            /Fe:consumer_test.exe
          consumer_test.exe

  test-windows-clang:
    name: Test Windows MSYS2 CLANG64
    needs: get_commit_message
    if: needs.get_commit_message.outputs.run_tests == '1'
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4

      - uses: msys2/setup-msys2@v2
        with:
          msystem: CLANG64
          update: true
          cache: true
          install: >-
            mingw-w64-clang-x86_64-clang
            mingw-w64-clang-x86_64-meson
            mingw-w64-clang-x86_64-ninja
            mingw-w64-clang-x86_64-cmake
            mingw-w64-clang-x86_64-openblas
            mingw-w64-clang-x86_64-tools
            mingw-w64-clang-x86_64-pkg-config
            git

      - name: Print environment info
        run: |
          echo "=== CPU ==="
          cat /proc/cpuinfo | grep 'model name' | head -1
          echo "Cores: $(nproc)"
          echo ""
          echo "=== Compiler ==="
          cc --version | head -1
          echo ""
          echo "=== OpenBLAS ==="
          pacman -Q mingw-w64-clang-x86_64-openblas

      - name: Install CMocka 2.0
        run: |
          git clone --depth 1 --branch cmocka-2.0.0 https://gitlab.com/cmocka/cmocka.git
          cmake -S cmocka -B cmocka/build -G Ninja \
            -DCMAKE_INSTALL_PREFIX=$MSYSTEM_PREFIX \
            -DBUILD_SHARED_LIBS=ON
          cmake --build cmocka/build
          cmake --install cmocka/build

      - name: Configure
        run: meson setup builddir -Dblas=openblas --default-library=shared

      - name: Build
        run: ninja -C builddir

      - name: Print OpenBLAS runtime info
        run: |
          cc -o openblas_info.exe tests/ci/openblas_info.c \
            $(pkg-config --cflags --libs openblas)
          ./openblas_info.exe

      - name: Debug ddrgev/sdrgev test5 failures
        run: |
          export PATH="$(pwd)/builddir/src:$PATH"
          echo "=== ddrgev ==="
          builddir/tests/d/test_ddrgev.exe 2>&1; echo "exit: $?"
          echo ""
          echo "=== sdrgev ==="
          builddir/tests/s/test_sdrgev.exe 2>&1; echo "exit: $?"
        continue-on-error: true
        env:
          OPENBLAS_NUM_THREADS: 1
          OPENBLAS_CORETYPE: Haswell

      - name: Test
        run: meson test -C builddir --print-errorlogs
        env:
          OPENBLAS_NUM_THREADS: 1
          OPENBLAS_CORETYPE: Haswell

      # --- MSVC consumer test: compile a C program with cl.exe against the
      #     Clang-built DLL to verify cross-compiler ABI. ---

      - name: Install to staging area
        run: |
          DESTDIR=$(pwd)/staging meson install -C builddir --no-rebuild

      - name: Detect DLL name
        id: dll_name
        run: |
          if [ -f builddir/src/libsemilapack.dll ]; then
            echo "dll=libsemilapack" >> $GITHUB_OUTPUT
          else
            echo "dll=semilapack" >> $GITHUB_OUTPUT
          fi

      - name: Collect DLLs and installed headers for MSVC test
        run: |
          DLL=${{ steps.dll_name.outputs.dll }}
          mkdir msvc_test
          cp builddir/src/${DLL}.dll msvc_test/
          cp /$MSYSTEM/bin/libopenblas.dll msvc_test/
          for dll in libc++.dll libunwind.dll; do
            [ -f /$MSYSTEM/bin/$dll ] && cp /$MSYSTEM/bin/$dll msvc_test/
          done
          # Copy installed headers (INT resolved, proper layout)
          mkdir -p msvc_test/include
          cp -r "$(find staging -type d -name semicolon_lapack)" msvc_test/include/
          echo "=== Installed headers ==="
          ls -la msvc_test/include/semicolon_lapack/

      - name: Generate MSVC import library
        run: |
          DLL=${{ steps.dll_name.outputs.dll }}
          gendef - builddir/src/${DLL}.dll > msvc_test/semilapack.def
          echo "=== .def file: first 10 lines ==="
          head -10 msvc_test/semilapack.def
          NEXPORTS=$(grep -c '^ ' msvc_test/semilapack.def || true)
          echo "=== Total exports: $NEXPORTS ==="

      - name: Build and run MSVC consumer test
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
          cd msvc_test
          lib /def:semilapack.def /out:semilapack.lib /machine:x64 /nologo
          cl.exe /std:c11 /O2 /W3 /nologo ^
            /I "include" ^
            ..\tests\ci\msvc_consumer_test.c ^
            semilapack.lib ^
            /Fe:consumer_test.exe
          consumer_test.exe
